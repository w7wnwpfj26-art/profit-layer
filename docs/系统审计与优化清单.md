# 系统全面审计与优化清单

> 审计日期：2026-02-09  
> 范围：自动化运行、AI 智能、代码完善度、升级优化点

---

## 一、自动化运行情况

### 1.1 已自动运行的部分

| 组件 | 触发方式 | 间隔/说明 |
|------|----------|------------|
| **AI Think Loop** | AI Engine 启动时 `asyncio.create_task(start_think_loop(3600))` | 每 3600 秒（1 小时）一次 |
| **Risk Monitor** | AI Engine 启动时 `risk_monitor.run_loop(60)` | 每 60 秒一次 |
| **Scanner** | 主进程 `setInterval` | 池子扫描=config 间隔(如 5 分钟)、价格 60s、仓位 5 分钟、告警 2 分钟、异常 3 分钟 |
| **Executor BullMQ Worker** | Executor 启动时 `createWorker(QUEUES.EXECUTE_TX)` | 常驻，消费 AI 推送的 execute-tx 任务 |
| **Executor Stream 桥接** | Redis Stream → BullMQ | 常驻，把 Python 写入的 stream 转成 Job |
| **AutoPilot** | `AUTOPILOT_ENABLED=true` 时 `autoPilot.start()` | 每 `cycleIntervalMs`（默认=scanner.intervalMs，如 5 分钟）一轮：拉池子→调 AI /strategy/analyze→执行信号、定期 harvest、风险检查 |

### 1.2 未自动运行 / 需注意

| 项目 | 说明 |
|------|------|
| **Strategy Worker（BullMQ）** | 已通过 `docker-compose` 的 `strategy-worker` 服务自动启动。启动命令：`docker compose up -d` 会包含 strategy-worker；若只启动部分服务，需显式加入：`docker compose up -d strategy-worker`。 |
| **AutoPilot 默认关闭** | `.env` 中 `AUTOPILOT_ENABLED=true` 才会跑全自动；否则只拉队列执行，不主动调 AI 做周期分析。 |
| **Dry Run 默认开启** | `AUTOPILOT_DRY_RUN` 默认为 true，只打日志不真实下单；要实盘需显式设为 `false`。 |

---

## 二、AI 是否足够聪明（已修复与待优化）

### 2.1 已修复（本次）

- **增强 Prompt 未传入 LLM**  
  - **问题**：Think Loop 里构建了「市场情绪 + Alpha 信号 + 历史记忆 + 决策准确率」的增强 prompt，但 `advisor.analyze(context)` 只用默认池子/组合 prompt，增强内容未使用。  
  - **修复**：`ai_advisor.analyze()` 增加可选参数 `user_prompt_override`；Think Loop 将增强片段与基础分析拼成完整 user prompt 传入。  
  - **效果**：DeepSeek 现在能基于情绪、Alpha、记忆、准确率做决策，明显更聪明。

### 2.2 仍可优化（未改代码）

| 项目 | 说明 |
|------|------|
| **Fallback 规则** | 已加强：复合得分(健康分*0.4+APR*0.6)排序、无高健康分时放宽至40、明确标注「规则引擎兜底」。 |
| **决策评估指标** | 已引入实际 PnL：enter/hold/increase 用 unrealized_pnl；exit/decrease 用 realized_pnl + APR 变化。format_for_prompt 会注入累计已实现/未实现盈亏供 LLM 参考。 |
| **组合优化假设** | 协方差为对角（池子不相关），实际加密资产相关性强，可引入相关性估计。 |
| **Transformer/RL 训练** | 已实现：`train_from_history()` 从 pool_snapshots 加载，`POST /ml/train` 可触发训练。 |

---

## 三、代码完善度与已修复问题

### 3.1 已修复（本次）

- **Scanner ESM 报错导致崩溃**  
  - **问题**：`alert-monitor.ts`、`anomaly-detector.ts`、`data-fusion.ts` 底部使用 `require.main === module`，在 ESM 下 `require` 未定义，Scanner 启动即崩。  
  - **修复**：改为 ESM 主模块判断：`path.resolve(process.argv[1]) === fileURLToPath(import.meta.url)`，三处均已改。

### 3.2 建议后续完善

| 项目 | 位置/说明 |
|------|------------|
| **Strategy Worker** | 已在 docker-compose 中配置。 |
| **JWT_SECRET** | 已在 `.env` 与 docker-compose 中配置。 |
| **AutoPilot cycleIntervalMs** | 当前用 `config.scanner.intervalMs`（如 5 分钟），若希望「AI 周期=1 小时」需在 executor 配置中单独设 `cycleIntervalMs=3600000`。 |
| **测试与回测** | 仅 friction 有单测；无策略回测，可逐步加。 |

---

## 四、升级与优化建议汇总

| 优先级 | 项 | 说明 |
|--------|----|------|
| P0（已完成） | 增强 Prompt 传入 LLM | Think Loop 的增强上下文已传入 DeepSeek。 |
| P0（已完成） | Scanner ESM 兼容 | 三处 `require.main` 已改为 ESM 主模块判断。 |
| P1（已完成） | 策略 Worker | docker-compose 已包含 strategy-worker 服务。 |
| P1（已完成） | JWT_SECRET | .env + docker-compose 已配置。 |
| P2（已完成） | AutoPilot 周期可配置 | 支持 `AUTOPILOT_CYCLE_MS` 覆盖，与 Scanner 解耦。 |
| P2（已完成） | 决策评估加入实际 PnL | 已引入 unrealized/realized PnL，format_for_prompt 注入累计盈亏。 |
| P2（已完成） | 减少 deposit 失败 | 失败时 metadata 记录 error；BullMQ 任务 attempts=3、指数退避；滑点统一 2%；TokenApprover 重试；FundPreparer 余额预检查；Gas buffer 30%。 |
| P2（已完成） | Fallback 规则加强 | 复合得分排序、动态健康分门槛、明确兜底标注。 |
| P2（已完成） | ML 训练流程 | Transformer/PPO 支持 train_from_history，`POST /ml/train` 接口。 |
| P2（已完成） | Grafana AI 监控 | ai-think-log.json 面板监控 Multi-Agent 决策日志。 |

---

## 五、当前自动化与智能度小结

- **自动化**：Think Loop（1h）、Risk Monitor（1min）、Scanner（多定时任务）、Executor Worker + Stream 桥接、AutoPilot（若开启）均已自动运行；仅 **Strategy Worker 需单独起进程**。  
- **智能度**：修复「增强 prompt 未传入」后，AI 能综合情绪、Alpha、记忆、准确率做决策，智能度显著提升；其余为增量优化（评估指标、组合假设、YieldPredictor 等）。  
- **代码**：Scanner 崩溃问题已解决；其余为文档、配置与后续增强项。
