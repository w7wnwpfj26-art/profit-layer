# DeFi æ•°æ®åº“å¯åŠ¨ä¸ç®¡ç†æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®æ”¯æŒä¸¤ç§æ•°æ®åº“éƒ¨ç½²æ–¹å¼ï¼š

| æ–¹å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **æœ¬åœ° Docker** | TimescaleDB å®¹å™¨ | æœ¬åœ°å¼€å‘ã€ç¦»çº¿ç¯å¢ƒ |
| **Supabase äº‘æ•°æ®åº“** | æ‰˜ç®¡ PostgreSQL | ç”Ÿäº§ç¯å¢ƒã€å…è¿ç»´ |

æ•°æ®åº“ç”¨äºå­˜å‚¨ï¼š
- DeFi æ± å­æ•°æ®ï¼ˆpoolsã€protocolsï¼‰
- ç”¨æˆ·æŒä»“ä¿¡æ¯ï¼ˆpositionsï¼‰
- äº¤æ˜“è®°å½•ï¼ˆtransactionsï¼‰
- æ—¶åºæ•°æ®ï¼ˆpool_snapshotsã€strategy_snapshotsï¼‰

---

## â˜ï¸ æ–¹æ¡ˆä¸€ï¼šSupabase äº‘æ•°æ®åº“ï¼ˆæ¨èï¼‰

Supabase æä¾›å…è´¹çš„æ‰˜ç®¡ PostgreSQL æ•°æ®åº“ï¼Œæ— éœ€æœ¬åœ° Dockerï¼Œé€‚åˆå¿«é€Ÿä¸Šæ‰‹å’Œç”Ÿäº§éƒ¨ç½²ã€‚

### 1. åˆ›å»º Supabase é¡¹ç›®

1. è®¿é—® [supabase.com](https://supabase.com) å¹¶æ³¨å†Œè´¦å·
2. ç‚¹å‡» **New Project** åˆ›å»ºæ–°é¡¹ç›®
3. è®¾ç½®é¡¹ç›®åç§°å’Œæ•°æ®åº“å¯†ç ï¼ˆè¯·è®°ä½æ­¤å¯†ç ï¼‰
4. é€‰æ‹©å°±è¿‘çš„åŒºåŸŸï¼ˆå¦‚ `ap-south-1`ï¼‰

### 2. è·å–è¿æ¥ä¿¡æ¯

åœ¨ Supabase Dashboard ä¸­ï¼š

1. è¿›å…¥ **Project Settings** â†’ **Database**
2. æ‰¾åˆ° **Connection string** éƒ¨åˆ†
3. å¤åˆ¶ä»¥ä¸‹ä¿¡æ¯ï¼š
   - Host: `db.xxxxxxxxxxxx.supabase.co`
   - Port: `5432` æˆ– `6543`ï¼ˆSession Poolerï¼‰
   - Database: `postgres`
   - User: `postgres` æˆ– `postgres.xxxxxxxxxxxx`

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶
cp packages/dashboard/.env.supabase.example packages/dashboard/.env.local

# ç¼–è¾‘é…ç½®
nano packages/dashboard/.env.local
```

å¡«å…¥ä½ çš„ Supabase è¿æ¥ä¿¡æ¯ï¼š

```bash
# Supabase æ•°æ®åº“é…ç½®
POSTGRES_HOST=db.xxxxxxxxxxxx.supabase.co
POSTGRES_PORT=6543        # æ¨èä½¿ç”¨ Session Pooler ç«¯å£
POSTGRES_DB=postgres
POSTGRES_USER=postgres.xxxxxxxxxxxx
POSTGRES_PASSWORD=ä½ çš„æ•°æ®åº“å¯†ç 
POSTGRES_SSL=true         # Supabase å¿…é¡»å¯ç”¨ SSL

# JWT å¯†é’¥
JWT_SECRET=ä½ çš„jwtå¯†é’¥_è‡³å°‘32å­—ç¬¦
```

### 4. åˆå§‹åŒ–æ•°æ®åº“è¡¨

æ–¹å¼ Aï¼šä½¿ç”¨åˆå§‹åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡åè¿è¡Œ
export $(cat packages/dashboard/.env.local | xargs)
node scripts/init-supabase.mjs
```

æ–¹å¼ Bï¼šåœ¨ Supabase SQL Editor æ‰‹åŠ¨æ‰§è¡Œ

1. è¿›å…¥ Supabase Dashboard â†’ **SQL Editor**
2. å¤åˆ¶ `infra/postgres/init.sql` å†…å®¹
3. ç‚¹å‡» **Run** æ‰§è¡Œ

### 5. éªŒè¯è¿æ¥

```bash
cd packages/dashboard
pnpm dev
```

è®¿é—® http://localhost:3002 ï¼Œå¦‚æœé¡µé¢æ­£å¸¸åŠ è½½å³è¡¨ç¤ºè¿æ¥æˆåŠŸã€‚

---

## ğŸ³ æ–¹æ¡ˆäºŒï¼šæœ¬åœ° Dockerï¼ˆå¼€å‘ç¯å¢ƒï¼‰

ä½¿ç”¨æœ¬åœ° TimescaleDB å®¹å™¨ï¼Œé€‚åˆç¦»çº¿å¼€å‘å’Œæµ‹è¯•ã€‚

### å¿«é€Ÿå¼€å§‹

### 1. å•Ÿå‹•æ•¸æ“šåº«ï¼ˆæ¨è–¦æ–¹å¼ï¼‰

ä½¿ç”¨æä¾›çš„è…³æœ¬ä¸€éµå•Ÿå‹•ï¼š

```bash
# åƒ…å•Ÿå‹•æ•¸æ“šåº«
bash scripts/start-database.sh

# å•Ÿå‹•æ•¸æ“šåº« + Redis + Grafana
bash scripts/start-database.sh --all

# å•Ÿå‹•ä¸¦æŸ¥çœ‹æ—¥èªŒ
bash scripts/start-database.sh --logs
```

### 2. é©—è­‰æ•¸æ“šåº«

```bash
# æª¢æŸ¥è¡¨çµæ§‹å’Œæ•¸æ“š
bash scripts/check-database.sh
```

### 3. å•Ÿå‹• Dashboard

```bash
cd packages/dashboard
pnpm install  # é¦–æ¬¡é‹è¡Œéœ€è¦
pnpm dev
```

ç„¶å¾Œè¨ªå•ï¼šhttp://localhost:3002

---

## ğŸ“Š æ•¸æ“šåº«é…ç½®

### é»˜èªé…ç½®

| é…ç½®é … | é»˜èªå€¼ | èªªæ˜ |
|--------|--------|------|
| ä¸»æ©Ÿ | `localhost` | æœ¬åœ°é–‹ç™¼ä½¿ç”¨ |
| ç«¯å£ | `5433` | é¿å…èˆ‡æœ¬æ©Ÿ PostgreSQL è¡çª |
| æ•¸æ“šåº«å | `defi_yield` | æ•¸æ“šåº«åç¨± |
| ç”¨æˆ¶å | `defi` | æ•¸æ“šåº«ç”¨æˆ¶ |
| å¯†ç¢¼ | `change_me_in_production` | âš ï¸ ç”Ÿç”¢ç’°å¢ƒè«‹ä¿®æ”¹ |

### ä¿®æ”¹é…ç½®

ç·¨è¼¯ `.env` æ–‡ä»¶ï¼š

```bash
# æ•¸æ“šåº«é…ç½®
POSTGRES_HOST=localhost
POSTGRES_PORT=5433
POSTGRES_DB=defi_yield
POSTGRES_USER=defi
POSTGRES_PASSWORD=your_secure_password_here
```

---

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### Docker Compose å‘½ä»¤

```bash
# å•Ÿå‹•æ•¸æ“šåº«
docker compose up -d timescaledb

# åœæ­¢æ•¸æ“šåº«
docker compose stop timescaledb

# é‡å•Ÿæ•¸æ“šåº«
docker compose restart timescaledb

# æŸ¥çœ‹æ—¥èªŒ
docker compose logs -f timescaledb

# æŸ¥çœ‹å®¹å™¨ç‹€æ…‹
docker compose ps

# åœæ­¢ä¸¦åˆªé™¤å®¹å™¨ï¼ˆæ•¸æ“šä¿ç•™ï¼‰
docker compose down

# åœæ­¢ä¸¦åˆªé™¤å®¹å™¨å’Œæ•¸æ“šå·ï¼ˆâš ï¸ å±éšªï¼‰
docker compose down -v
```

### æ•¸æ“šåº«å‘½ä»¤è¡Œ

```bash
# é€²å…¥ PostgreSQL å‘½ä»¤è¡Œ
docker compose exec timescaledb psql -U defi -d defi_yield

# åœ¨å‘½ä»¤è¡Œä¸­å¯ä»¥åŸ·è¡Œï¼š
\dt              # åˆ—å‡ºæ‰€æœ‰è¡¨
\d pools         # æŸ¥çœ‹ pools è¡¨çµæ§‹
\q               # é€€å‡º

# åŸ·è¡Œ SQL æŸ¥è©¢ï¼ˆä¸é€²å…¥å‘½ä»¤è¡Œï¼‰
docker compose exec -T timescaledb psql -U defi -d defi_yield -c "SELECT COUNT(*) FROM pools;"
```

---

## ğŸ“ æ•¸æ“šåº«è¡¨çµæ§‹

### ä¸»è¦è¡¨

| è¡¨å | èªªæ˜ | é¡å‹ |
|------|------|------|
| `chains` | æ”¯æŒçš„å€å¡Šéˆ | åŸºç¤è¡¨ |
| `protocols` | DeFi å”è­° | åŸºç¤è¡¨ |
| `pools` | æµå‹•æ€§æ±  | æ•¸æ“šè¡¨ |
| `pool_snapshots` | æ± å­æ­·å²å¿«ç…§ | æ™‚åºè¡¨ |
| `positions` | ç”¨æˆ¶æŒå€‰ | æ•¸æ“šè¡¨ |
| `transactions` | äº¤æ˜“è¨˜éŒ„ | æ•¸æ“šè¡¨ |
| `strategies` | ç­–ç•¥é…ç½® | åŸºç¤è¡¨ |
| `strategy_snapshots` | ç­–ç•¥æ­·å²å¿«ç…§ | æ™‚åºè¡¨ |
| `system_config` | ç³»çµ±é…ç½® | é…ç½®è¡¨ |
| `audit_log` | å¯©è¨ˆæ—¥èªŒ | æ—¥èªŒè¡¨ |

### æŸ¥çœ‹è¡¨æ•¸æ“š

```bash
# æŸ¥çœ‹éˆåˆ—è¡¨
docker compose exec -T timescaledb psql -U defi -d defi_yield -c "SELECT * FROM chains;"

# æŸ¥çœ‹æ± å­æ•¸é‡
docker compose exec -T timescaledb psql -U defi -d defi_yield -c "SELECT COUNT(*) FROM pools;"

# æŸ¥çœ‹ APR æœ€é«˜çš„ 10 å€‹æ± å­
docker compose exec -T timescaledb psql -U defi -d defi_yield -c "
SELECT pool_id, protocol_id, chain_id, symbol, apr_total, tvl_usd 
FROM pools 
WHERE is_active = true 
ORDER BY apr_total DESC 
LIMIT 10;"
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### å•é¡Œ 1ï¼šDashboard é€£ä¸ä¸Šæ•¸æ“šåº«

**ç—‡ç‹€ï¼š**
```
Error: connect ECONNREFUSED 127.0.0.1:5433
```

**è§£æ±ºæ–¹æ¡ˆï¼š**

1. ç¢ºèªæ•¸æ“šåº«é‹è¡Œï¼š
   ```bash
   docker compose ps timescaledb
   # æ‡‰è©²é¡¯ç¤º "Up" ç‹€æ…‹
   ```

2. æª¢æŸ¥ç«¯å£æ˜ å°„ï¼š
   ```bash
   docker compose port timescaledb 5432
   # æ‡‰è©²é¡¯ç¤º: 0.0.0.0:5433
   ```

3. é©—è­‰é€£æ¥ï¼š
   ```bash
   bash scripts/check-database.sh
   ```

4. æª¢æŸ¥ `.env` é…ç½®ï¼š
   ```bash
   grep POSTGRES_ .env
   ```

### å•é¡Œ 2ï¼šæ•¸æ“šåº«å•Ÿå‹•å¤±æ•—

**å¯èƒ½åŸå› ï¼š**
- ç«¯å£è¢«ä½”ç”¨
- Docker è³‡æºä¸è¶³
- æ•¸æ“šå·æå£

**è§£æ±ºæ–¹æ¡ˆï¼š**

```bash
# 1. æŸ¥çœ‹è©³ç´°æ—¥èªŒ
docker compose logs timescaledb

# 2. æª¢æŸ¥ç«¯å£ä½”ç”¨
lsof -i :5433  # macOS/Linux
netstat -ano | findstr :5433  # Windows

# 3. é‡æ–°å‰µå»ºå®¹å™¨
docker compose down
docker compose up -d timescaledb

# 4. å¦‚æœæ•¸æ“šå·æå£ï¼ˆâš ï¸ æœƒæ¸…ç©ºæ•¸æ“šï¼‰
docker compose down -v
docker compose up -d timescaledb
```

### å•é¡Œ 3ï¼šæ•¸æ“šåº«æ•¸æ“šç‚ºç©º

**æª¢æŸ¥æ­¥é©Ÿï¼š**

```bash
# 1. ç¢ºèªè¡¨å·²å‰µå»º
bash scripts/check-database.sh

# 2. æŸ¥çœ‹åˆå§‹åŒ–æ—¥èªŒ
docker compose logs timescaledb | grep -i "init"

# 3. æ‰‹å‹•åŸ·è¡Œåˆå§‹åŒ–è…³æœ¬
docker compose exec -T timescaledb psql -U defi -d defi_yield < infra/postgres/init.sql
```

å¦‚æœ `pools` å’Œ `protocols` è¡¨ç‚ºç©ºï¼Œéœ€è¦ï¼š
- é‹è¡Œ Scanner æœå‹™ä¾†æŠ“å–å¯¦æ™‚æ•¸æ“š
- æˆ–é‹è¡Œç¨®å­è…³æœ¬å¡«å……æ¨¡æ“¬æ•¸æ“šï¼š`pnpm seed`

---

## ğŸ” å®‰å…¨å»ºè­°

### é–‹ç™¼ç’°å¢ƒ

- âœ… ä½¿ç”¨é»˜èªé…ç½®å³å¯
- âœ… ç«¯å£ 5433 åƒ…ç›£è½ localhost

### ç”Ÿç”¢ç’°å¢ƒ

1. **ä¿®æ”¹å¯†ç¢¼**
   ```bash
   # .env
   POSTGRES_PASSWORD=ä½¿ç”¨å¼·å¯†ç¢¼
   ```

2. **é™åˆ¶è¨ªå•**
   ```yaml
   # docker-compose.yml
   services:
     timescaledb:
       ports:
         - "127.0.0.1:5433:5432"  # åƒ…æœ¬åœ°è¨ªå•
   ```

3. **å‚™ä»½æ•¸æ“š**
   ```bash
   # å‚™ä»½
   docker compose exec -T timescaledb pg_dump -U defi defi_yield > backup.sql
   
   # æ¢å¾©
   docker compose exec -T timescaledb psql -U defi -d defi_yield < backup.sql
   ```

4. **å•Ÿç”¨ SSL**ï¼ˆå¯é¸ï¼‰
   - é…ç½® PostgreSQL SSL è­‰æ›¸
   - ä¿®æ”¹é€£æ¥å­—ç¬¦ä¸²æ·»åŠ  `sslmode=require`

---

## ğŸ“ˆ æ€§èƒ½å„ªåŒ–

### 1. é€£æ¥æ± é…ç½®

Dashboard å·²é…ç½®é€£æ¥æ± ï¼ˆæœ€å¤§ 5 å€‹é€£æ¥ï¼‰ï¼š

```typescript
// packages/dashboard/app/api/pools/route.ts
const pool = new pg.Pool({
  max: 5,  // æœ€å¤§é€£æ¥æ•¸
  // ...
});
```

### 2. ç´¢å¼•å„ªåŒ–

æ•¸æ“šåº«å·²å‰µå»ºå¿…è¦ç´¢å¼•ï¼š

```sql
-- æŸ¥çœ‹ç¾æœ‰ç´¢å¼•
SELECT tablename, indexname, indexdef 
FROM pg_indexes 
WHERE schemaname = 'public';
```

### 3. æ™‚åºæ•¸æ“šæ¸…ç†

å®šæœŸæ¸…ç†èˆŠçš„å¿«ç…§æ•¸æ“šï¼š

```sql
-- åˆªé™¤ 90 å¤©å‰çš„æ± å­å¿«ç…§
DELETE FROM pool_snapshots 
WHERE time < NOW() - INTERVAL '90 days';

-- åˆªé™¤ 180 å¤©å‰çš„ç­–ç•¥å¿«ç…§
DELETE FROM strategy_snapshots 
WHERE time < NOW() - INTERVAL '180 days';
```

---

## ğŸ”„ æ•¸æ“šé·ç§»

### å°å‡ºæ•¸æ“š

```bash
# å°å‡ºæ•´å€‹æ•¸æ“šåº«
docker compose exec -T timescaledb pg_dump -U defi defi_yield > defi_yield_backup.sql

# åƒ…å°å‡ºè¡¨çµæ§‹
docker compose exec -T timescaledb pg_dump -U defi -s defi_yield > schema.sql

# åƒ…å°å‡ºæ•¸æ“š
docker compose exec -T timescaledb pg_dump -U defi -a defi_yield > data.sql
```

### å°å…¥æ•¸æ“š

```bash
# å°å…¥æ•´å€‹å‚™ä»½
docker compose exec -T timescaledb psql -U defi -d defi_yield < defi_yield_backup.sql

# æˆ–ä½¿ç”¨ç®¡é“
cat defi_yield_backup.sql | docker compose exec -T timescaledb psql -U defi -d defi_yield
```

---

## ğŸ”— ç›¸é—œè³‡æº

### é …ç›®æ–‡æª”
- [Git èˆ‡æ›´æ–°é…ç½®èªªæ˜](./GITä¸æ›´æ–°é…ç½®è¯´æ˜.md)
- [æ¡Œé¢æ‡‰ç”¨ç™¼å¸ƒæµç¨‹](../packages/desktop/RELEASE.md)
- [é …ç›®ä¸» README](../README.md)

### å®˜æ–¹æ–‡æª”
- [TimescaleDB æ–‡æª”](https://docs.timescale.com/)
- [PostgreSQL æ–‡æª”](https://www.postgresql.org/docs/)
- [Docker Compose æ–‡æª”](https://docs.docker.com/compose/)

### å¸¸ç”¨å·¥å…·
- [pgAdmin](https://www.pgadmin.org/) - PostgreSQL åœ–å½¢åŒ–ç®¡ç†å·¥å…·
- [DBeaver](https://dbeaver.io/) - é€šç”¨æ•¸æ“šåº«ç®¡ç†å·¥å…·
- [TablePlus](https://tableplus.com/) - macOS æ•¸æ“šåº«å®¢æˆ¶ç«¯

---

## ğŸ“ ç²å–å¹«åŠ©

å¦‚æœé‡åˆ°å•é¡Œï¼š

1. æŸ¥çœ‹æ—¥èªŒï¼š`docker compose logs -f timescaledb`
2. é‹è¡Œæª¢æŸ¥è…³æœ¬ï¼š`bash scripts/check-database.sh`
3. æŸ¥çœ‹æœ¬æ–‡æª”çš„æ•…éšœæ’æŸ¥ç« ç¯€
4. æª¢æŸ¥ Docker å’Œç£ç›¤ç©ºé–“æ˜¯å¦å……è¶³

---

**æœ€å¾Œæ›´æ–°ï¼š** 2026-02-07
