# ProfitLayer: 智能资产矩阵 (Intelligent Asset Matrix) - 设置指南

本文档为**详细设置指南**，涵盖从环境变量、数据库、各服务启动到 Dashboard 内所有可配置项，便于按步骤完成部署与调优。

---

## 一、环境与前置要求

### 1.1 硬件与软件

| 项目 | 要求 |
|------|------|
| 操作系统 | Windows / macOS / Linux |
| 内存 | 建议 4GB 以上 |
| Node.js | 18+（推荐 20+） |
| pnpm | 9+ |
| Docker Desktop | 已安装并运行（用于数据库、Redis、Grafana） |
| Python | 3.11+（用于 AI 引擎） |

### 1.2 克隆与目录

```bash
git clone <你的仓库地址> dapp
cd dapp
```

---

## 二、环境变量配置（.env）

在项目根目录复制模板并编辑：

```bash
cp .env.example .env
# 使用任意编辑器修改 .env
```

### 2.1 数据库（必配）

| 变量 | 说明 | 示例 |
|------|------|------|
| POSTGRES_HOST | 数据库主机 | `localhost` |
| POSTGRES_PORT | 端口（Docker 映射后多为 5433） | `5433` |
| POSTGRES_DB | 数据库名 | `defi_yield` |
| POSTGRES_USER | 用户名 | `defi` |
| POSTGRES_PASSWORD | 密码 | **生产环境务必改为强密码** |

### 2.2 Redis（必配）

| 变量 | 说明 | 示例 |
|------|------|------|
| REDIS_HOST | Redis 主机 | `localhost` |
| REDIS_PORT | 端口 | `6379` |
| REDIS_PASSWORD | 密码（可选） | 留空或设置 |

### 2.3 链 RPC（按需）

用于 Scanner、Executor、AI 情绪/Alpha 等。可先用公共 RPC，生产建议自建或付费节点。

| 变量 | 说明 |
|------|------|
| ETH_RPC_URL | 以太坊主网 |
| ARBITRUM_RPC_URL | Arbitrum One |
| BSC_RPC_URL | BNB Chain |
| POLYGON_RPC_URL | Polygon |
| BASE_RPC_URL | Base |
| OPTIMISM_RPC_URL | Optimism |
| SOLANA_RPC_URL | Solana 主网 |
| APTOS_RPC_URL | Aptos 主网 |

示例（可替换为 Ankr、QuickNode 等）：

```
ETH_RPC_URL=https://rpc.ankr.com/eth
ARBITRUM_RPC_URL=https://arb1.arbitrum.io/rpc
```

### 2.4 钱包与安全（敏感）

- **WALLET_ENCRYPTION_KEY**：32 字符密钥，用于加密存储热钱包私钥，**务必随机且保密**。
- **EVM_PRIVATE_KEY / SOLANA_PRIVATE_KEY / APTOS_PRIVATE_KEY**：若使用热钱包自动执行，在此配置；不配置则仅用「冷钱包 + 仪表盘签名」方式。

**注意**：切勿将 `.env` 提交到 Git；生产环境务必使用强密码与独立密钥。

### 2.5 AI 引擎连接

| 变量 | 说明 | 示例 |
|------|------|------|
| AI_ENGINE_HOST | AI 服务主机 | `localhost` |
| AI_ENGINE_PORT | 端口 | `8000` |
| AI_ENGINE_URL | 完整 URL（Dashboard 调用用） | `http://localhost:8000` |

Dashboard 与 Scanner/Executor 需能访问该 URL。

### 2.6 AI 顾问（LLM）

| 变量 | 说明 | 示例 |
|------|------|------|
| DEEPSEEK_API_KEY | DeepSeek API Key | 从 https://platform.deepseek.com 获取 |
| AI_MODEL | 模型名 | `deepseek-chat` / `deepseek-reasoner` / `gpt-4o` |
| AI_BASE_URL | API 基础地址 | `https://api.deepseek.com` 或 `https://api.openai.com/v1` |

不配置 API Key 时，AI 引擎会退化为内置规则引擎（无 LLM 调用）。

### 2.7 扫描与风险

| 变量 | 说明 | 默认 |
|------|------|------|
| SCAN_INTERVAL_MS | 池子扫描间隔（毫秒） | 300000（5 分钟） |
| MIN_TVL_USD | 最低追踪 TVL（美元） | 100000 |
| MIN_APR_PCT | 最低追踪 APR（%） | 1.0 |
| MAX_SINGLE_TX_USD | 单笔交易上限（美元） | 10000 |
| MAX_DAILY_TX_USD | 每日交易上限（美元） | 50000 |
| STOP_LOSS_PCT | 止损触发比例（%） | 10 |
| KILL_SWITCH | 紧急停止（true/false） | false |

### 2.8 全自动模式（AutoPilot）

| 变量 | 说明 | 默认 |
|------|------|------|
| AUTOPILOT_ENABLED | 是否开启全自动 | false |
| AUTOPILOT_DRY_RUN | 是否仅模拟不真实下单 | true |
| TOTAL_CAPITAL_USD | 总投资金额（美元） | 10000 |

### 2.9 通知

| 变量 | 说明 |
|------|------|
| TELEGRAM_BOT_TOKEN | Telegram Bot Token（@BotFather） |
| TELEGRAM_CHAT_ID | 接收告警的 Chat ID |
| ALERT_WEBHOOK_URL | 飞书/钉钉/Slack 等 Webhook（可选） |

### 2.10 认证与 Dashboard

| 变量 | 说明 |
|------|------|
| JWT_SECRET | 登录 JWT 签名密钥，**生产必改** |
| DASHBOARD_PORT | 仪表盘端口（可选，默认脚本内 3002） | 3002 |

---

## 三、数据库与基础设施

### 3.1 启动数据库与 Redis

推荐使用项目脚本：

```bash
# 仅数据库
bash scripts/start-database.sh

# 数据库 + Redis + Grafana
bash scripts/start-database.sh --all
```

或使用 Docker Compose：

```bash
docker compose up -d timescaledb redis
# 可选：grafana
docker compose up -d grafana
```

确认 `.env` 中 `POSTGRES_PORT` 与 `docker-compose.yml` 中映射一致（例如宿主机 5433 映射容器 5432）。

### 3.2 首次建表与 AI 表

- 全新安装：`init.sql` 已包含所有表（含 `ai_think_log`、`ai_memory`、`ai_decisions`）。
- 若数据库是早期创建的，需执行 AI 表迁移：

```bash
# 本地
psql -h localhost -p 5433 -U defi -d defi_yield -f infra/postgres/migrations/004_ai_agent_tables.sql

# Docker
docker compose exec -T timescaledb psql -U defi -d defi_yield < infra/postgres/migrations/004_ai_agent_tables.sql
```

### 3.3 验证数据库

```bash
bash scripts/check-database.sh
```

应能看到 chains、protocols、pools、system_config 等表及初始数据。

---

## 四、系统配置项（Dashboard 设置页）

以下配置存储在数据库 `system_config` 表中，可在 **Dashboard → 系统设置** 中修改并保存；部分项同时受 `.env` 影响（如 RPC、API Key 等以环境变量为准时，以实际代码逻辑为准）。

### 4.1 自动驾驶与紧急

| 配置键 | 说明 | 典型值 |
|--------|------|--------|
| autopilot_enabled | 是否开启全自动策略执行 | false / true |
| autopilot_dry_run | 是否仅模拟（不真实下单） | true / false |
| total_capital_usd | 总投资金额（美元） | 10000 |
| kill_switch | 紧急停止所有交易 | false / true |

### 4.2 风险与额度

| 配置键 | 说明 | 典型值 |
|--------|------|--------|
| max_single_tx_usd | 单笔交易上限（美元） | 10000 |
| max_daily_tx_usd | 每日交易上限（美元） | 50000 |
| stop_loss_pct | 止损比例（%） | 10 |
| max_risk_score | 最大风险评分（0–100） | 60 |
| min_health_score | 选池最低健康分 | 60 |
| rebalance_threshold_pct | 再平衡偏差阈值（%） | 20 |

### 4.3 扫描器

| 配置键 | 说明 | 典型值 |
|--------|------|--------|
| scan_interval_min | 池子扫描间隔（分钟） | 5 |
| min_tvl_usd | 最低追踪 TVL（美元） | 100000 |
| min_apr_pct | 最低追踪年化（%） | 1 |
| compound_interval_hr | 自动复投间隔（小时） | 6 |

### 4.4 钱包地址（只读展示 / 由「钱包管理」写入）

| 配置键 | 说明 |
|--------|------|
| evm_wallet_address | 当前连接的 EVM 钱包地址 |
| aptos_wallet_address | Aptos 钱包地址 |
| solana_wallet_address | Solana 钱包地址 |

在 **钱包管理** 页通过 OKX 等插件连接后，会更新上述键。

### 4.5 通知

| 配置键 | 说明 |
|--------|------|
| telegram_bot_token | Telegram Bot Token |
| telegram_chat_id | 接收通知的 Chat ID |
| alert_webhook_url | 告警 Webhook URL |

### 4.6 AI 策略顾问（若表中有以下键）

| 配置键 | 说明 | 典型值 |
|--------|------|--------|
| deepseek_api_key | DeepSeek API Key | sk-... |
| ai_model | 模型 | deepseek-chat / deepseek-reasoner / gpt-4o |
| ai_base_url | API 基础地址 | https://api.deepseek.com |
| ai_auto_approve | 是否由 AI 自动审批信号 | true / false |

**说明**：若 `system_config` 中尚无 `deepseek_api_key`、`ai_model`、`ai_base_url`、`ai_auto_approve`，需先在数据库中插入对应行后，才能在设置页中显示并保存。AI 引擎也会从数据库读取这些配置（若实现中有读 DB）。

### 4.7 利润归集与冷钱包（若已实现）

| 配置键 | 说明 |
|--------|------|
| profit_sweep_enabled | 是否开启自动利润归集 |
| profit_sweep_threshold | 归集阈值（美元） |
| cold_wallet_address | 冷钱包地址 |

---

## 五、服务启动顺序与命令

### 5.1 推荐顺序

1. 启动基础设施：TimescaleDB、Redis（可选 Grafana）。
2. 执行迁移（仅旧库需要）：`004_ai_agent_tables.sql`。
3. 启动 AI 引擎（Python）。
4. 启动 Dashboard（Next.js）。
5. 按需启动 Scanner、Executor、Telegram Bot。

### 5.2 启动命令示例

```bash
# 1. 基础设施（已上述）
bash scripts/start-database.sh --all

# 2. AI 引擎（在项目根或 ai-engine 目录）
cd ai-engine
python3 -m venv .venv
source .venv/bin/activate   # Windows: .venv\Scripts\activate
pip install -e ".[dev]"
uvicorn src.api.server:app --host 0.0.0.0 --port 8000 --reload

# 3. Dashboard（新终端）
cd packages/dashboard
pnpm install
pnpm dev
# 默认已绑定 0.0.0.0:3002，本机与局域网可访问 http://<本机IP>:3002

# 4. Scanner（新终端，可选）
pnpm scanner

# 5. Executor（新终端，可选）
pnpm executor

# 6. Telegram Bot（新终端，若已配置 token/chat_id）
pnpm bot
```

### 5.3 Docker 一键运行（若已配置 compose）

```bash
docker compose up -d
```

将启动 timescaledb、redis、grafana、scanner、executor、ai-engine、dashboard；端口以 `docker-compose.yml` 和 `.env` 为准。

---

## 六、Dashboard 使用要点

### 6.1 登录

- 首次使用需注册账号（或使用已写入 `users` 表的账号）。
- 登录后 JWT 存在前端，请求会携带 Token 访问需鉴权接口。

### 6.2 钱包管理

- 打开 **钱包管理**，安装 OKX Wallet 等插件后点击「连接 EVM 钱包」。
- 连接成功后，地址会写入 `evm_wallet_address`，并可在「持仓管理」等处使用。
- 余额扫描通过 Dashboard 后端代理 RPC，避免浏览器 CORS 问题。

### 6.3 系统设置

- 所有「系统设置」中的项保存后写入 `system_config`。
- 紧急停止、全自动开关、模拟模式等会即时影响 Executor / Scanner 行为（若它们从 DB 读取配置）。
- 修改 AI API Key / 模型后，可点击「测试 AI 连接」验证。

### 6.4 局域网访问

- 开发模式已绑定 `0.0.0.0`，同局域网设备可通过 `http://<本机IP>:3002` 访问。
- 若无法访问，请检查本机防火墙是否放行 3002 端口。

---

## 七、常见问题

### 7.1 Dashboard 无法连接数据库

- 确认 TimescaleDB 已启动：`docker compose ps timescaledb`。
- 确认 `.env` 中 `POSTGRES_HOST`、`POSTGRES_PORT`、`POSTGRES_USER`、`POSTGRES_PASSWORD`、`POSTGRES_DB` 与数据库实际一致。
- 运行 `bash scripts/check-database.sh` 验证连接。

### 7.2 AI 引擎不可用 / 情绪、思考日志为空

- 确认 AI 引擎已启动且 `GET http://localhost:8000/health` 返回 200。
- Dashboard 的 `AI_ENGINE_URL`（或 .env 中）指向正确的 AI 服务地址。
- 若使用 LLM：在设置页配置 DeepSeek API Key 并保存，再测试连接。

### 7.3 设置页没有「AI 策略顾问」相关输入框

- 可能是 `system_config` 中缺少 `deepseek_api_key`、`ai_model`、`ai_base_url`、`ai_auto_approve`。
- 可在数据库执行插入，例如（键名与前端一致）：

```sql
INSERT INTO system_config (key, value, description, category) VALUES
  ('deepseek_api_key', '', 'DeepSeek API Key', 'ai'),
  ('ai_model', 'deepseek-chat', 'AI 模型', 'ai'),
  ('ai_base_url', 'https://api.deepseek.com', 'API 基础地址', 'ai'),
  ('ai_auto_approve', 'false', 'AI 自动审批信号', 'ai')
ON CONFLICT (key) DO NOTHING;
```

### 7.4 端口冲突

- 修改 `.env` 中 `DASHBOARD_PORT`、`POSTGRES_PORT` 等，或修改 `packages/dashboard/package.json` 中 `dev` 的 `-p` 参数。
- Docker 映射端口在 `docker-compose.yml` 中修改。

---

## 八、相关文档

- [快速开始](./快速开始.md)：5 分钟最小启动流程  
- [数据库启动指南](./数据库启动指南.md)：数据库详细配置与管理  
- [AI能力说明](./AI能力说明.md)：AI 模块能力与原理  
- [GIT与更新配置说明](./GIT与更新配置说明.md)：Git 与桌面端更新  
- [ARCHITECTURE](./ARCHITECTURE.md)：系统架构概览  
